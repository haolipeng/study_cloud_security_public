# 一、为什么需要TCP会话表

仅仅解析每个数据包是不够的：难以区分一条具体 TCP 连接

数据包是无状态的，需要通过五元组 (src ip, dst ip, src port, dst port, protocol) 标识一条会话

应用场景：DFI流量统计、防火墙、DPI 等，深度包检测和深度流检测。



# 二、TCP会话表基础概念

## 2、1 会话表的作用

- 将离散的数据包聚合成流 (flow/session)
- 在表项中维护会话状态和统计信息



## 2、2 会话表的键 (key) 与值 (value)

key: TCP 五元组

value: 包含状态机 (如 ESTABLISHED 等)、统计数据 (bps/bpp)、指针等



## 2、3 会话表的生命周期

- 会话创建 (握手包或第一个数据包插入表)
- 会话更新 (新包到来，更新统计)
- 会话销毁 (FIN/RST 或超时回收)



# 三、tcp会话表实现机制

## **3、1 定义数据结构**

- 会话 key：五元组
- 会话 entry：状态、上行/下行字节数、包数、时间戳



## **3、2 在 rte_hash 查找/插入**

- 没有找到则分配新会话 (mempool) 并插入
- 找到则更新统计信息



## **3、3 维护会话状态**

- 使用 TCP 标志位更新会话状态机 (SYN/FIN/RST)
- 超时清理机制：定时器扫描空闲连接



## **3、4 统计方向**

- 上行与下行的区分：根据源或目的 IP 是否是“本机/客户侧”来判定
- 每次更新时增加对应方向的字节数 / 包数



## 3、5 具体实现

**rte_hash**

- 用于快速查找五元组对应的会话

**rte_mempool**

- 管理会话表中 value 的内存池分配和释放



# 4、具体代码实现

## 4、1 会话创建

## 4、2 会话更新

## 4、3 会话销毁