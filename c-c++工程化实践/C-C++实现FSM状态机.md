

# 一、什么是状态机？ What

[状态机](https://link.juejin.cn/?target=https%3A%2F%2Fzh.wikipedia.org%2Fzh-hans%2F%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%3Fwprov%3Dsfla1)一般指有限状态机（英语：finite-state machine，缩写：**FSM**）又称有限状态自动机。

每个状态机都有四个核心要素：

- 状态（State）：系统当前的情况
- 事件（Event）：触发状态改变的条件
- 转换（Transition）：从一个状态到另一个状态的过程
- 动作（Action）：进入或离开状态时执行的操作



# 二、状态机应用

以生活中随处可见的自动售卖机为例子，让大家有个大致的了解。

**符合实际售货机逻辑的状态机：**

1. 空闲等待 → 选择商品 → 已选商品

1. 已选商品 → 投币（需要验证金额） → 已投币

1. 已投币 → 出货 → 出货中

1. 出货中 → 完成 → 空闲等待



在讲解的时候，就以自动售卖机的例子来讲解。

初始化二维数组的方式

```
售货机状态转换表 (VendingMachineTransitionTable)
===============================================

状态索引   | 状态名称   | 选择商品(0)        | 投币(1)            | 出货(2)            | 重置(3)
---------|-----------|-------------------|-------------------|-------------------|------------------
   0     | 空闲等待   | → 已选商品(1)       |       -           |       -           |       -
         |           | ActionIndex: 0    |                   |                   |
---------|-----------|-------------------|-------------------|-------------------|------------------
   1     | 已选商品   |       -           | → 已投币(2)        |       -           |       -
         |           |                   | ActionIndex: 1    |                   |
---------|-----------|-------------------|-------------------|-------------------|------------------
   2     | 已投币     |       -           |       -           | → 出货中(3)        |       -
         |           |                   |                   | ActionIndex: 0    |
---------|-----------|-------------------|-------------------|-------------------|------------------
   3     | 出货中     |       -           |       -           |       -           | → 空闲等待(0)
         |           |                   |                   |                   | ActionIndex: 0
```



# 三、实现状态机

- 定义有限状态机的核心结构和接口
- 实现State状态结构体和相关的方法
- 实现状态转换(Transition)逻辑
- 实现有限状态机(FSM)主体结构
- 创建example示例用法和测试案例
- 增加单元测试用例



实现状态机，分为三个阶段：

**第一阶段：普普通通的状态机**

就是状态切换，比如自动售货机的“空闲等待”状态切换到“商品已选”状态。



**第二阶段：带条件的事件触发**

事件触发时，还需要满足指定的条件condition，才能跳转到下一个状态

bool ( *guard )( void *condition, struct event *event );

其中condition是event必须满足的条件。



**第三阶段、带有指定动作的状态机**

状态机支持多种类型的动作：

1. 状态进入动作 (Entry Actions)

2. 状态退出动作 (Entry Actions)
3. 转换动作 (Transition Actions)

我们目前只实现第一个阶段的代码，后续在基础版上，继续实现第二阶段和第三阶段



# 四、参考链接



**什么是状态机？一篇文章就够了**

https://juejin.cn/post/7118021175065722893



**介绍一个状态机框架，纯c语言打造**

https://juejin.cn/post/7118381019283062820



将这个整体功能进行拆解，形成一个系列的文章，c语言手把手教你写状态机。

1、核心结构体的定义

2、guard功能

3、enterEntry和exitEntry功能



https://cloud.tencent.com/developer/article/2238292?cps_key=1d358d18a7a17b4a6df8d67a62fd3d3d